# Get the task count from a list of project GIDs
import os
import json
import requests
from dotenv import load_dotenv

# Load environment variables
load_dotenv()

def get_task_count_from_project_GID(project_gid: str, access_token: str) -> int:
    """
    Get the task count for a project from Asana API
    
    Args:
        project_gid: Project GID
        access_token: Asana access token
        
    Returns:
        Number of tasks in the project
    """
    url = f'https://app.asana.com/api/1.0/projects/{project_gid}/task_counts'
    headers = {
        'accept': 'application/json',
        'authorization': f'Bearer {access_token}'
    }
    params = {
        'opt_fields': 'num_tasks'
    }
    
    try:
        response = requests.get(url, headers=headers, params=params)
        response.raise_for_status()
        data = response.json()
        
        # Asana API typically wraps responses in 'data' key
        # The task_counts endpoint returns task count information
        if isinstance(data, dict) and 'data' in data:
            # If response is wrapped in 'data' key
            task_counts = data['data']
            if isinstance(task_counts, list) and len(task_counts) > 0:
                # If data is a list, get first item
                return task_counts[0].get('num_tasks', 0)
            elif isinstance(task_counts, dict):
                # If data is a dict, get num_tasks directly
                return task_counts.get('num_tasks', 0)
        elif isinstance(data, dict) and 'num_tasks' in data:
            # If response is directly a dict with num_tasks
            return data.get('num_tasks', 0)
        elif isinstance(data, list) and len(data) > 0:
            # If response is directly a list
            if isinstance(data[0], dict):
                return data[0].get('num_tasks', 0)
        
        return 0
    except requests.exceptions.RequestException as e:
        print(f"Error fetching task count for project {project_gid}: {e}")
        return 0


project_GID_list = [
"1209670241247456",
"1207401689716524",
"1207599856837084",
"1207744507032195",
"1208790224379335",
"1207931717530407",
"1207722134870402",
"1209755485393570",
"1207722511334892",
"1206835287114553",
"1209020289079877",
"1208246397156176",
"1211028802323242",
"1211296592742932",
"1207931717530299",
"1204820764302059",
"1209980831176849",
"1210962441602410",
"1207413829228228",
"1209661531978575",
"1209324707998092",
"1211067354407900",
"1201769649997354",
"1208021047952985",
"1209757104186341",
"1206396054073419",
"1209660822940485",
"1202011327012956",
"1202011327012956",
"1202017789763052",
"1211762627974041",
"1202848664849121",
"1210146503205032",
"1207469001658854",
"1208143258940139",
"1201668388055244",
"377184657233986",
"1207668601734586",
"1210990004350835",
"1209976010654781",
"1209101177425265",
"1207931717530371",
"1209331657533757",
"1208531721844593",
"1206566699246039",
"1202198955540360",
"1203792603847843",
"1206355124124877",
"1209852258792933",
"1201959466824376",
"1202198955540360",
"1201997623514342",
"1211103877794723",
"1206754892659013",
"1207129822443936",
"1207522975026447",
"1207448790384675",
"1206525987654870",
"1202008550450876",
"1209811865393252",
"1204073080518582",
"1209226309317546",
"1201997748599444",
"1201944213595853",
"1211389004379875",
"1202001505322739",
"706549318301154",
"1205366800721766",
"1208801508897860",
"1204067243200283",
"1201721156974866",
"1202115152957168",
"1201923199778254",
"1200670717859396",
"1200670785956334",
"551365761187318",
"1204394929114626",
"1204845884279023",
"1210130088736420",
"1201805737718436",
"1202001504658033",
"1202067237365290",
"1201944915672225",
"1210226294651081",
"1201759996136469",
"1209020250329976",
"1206695579421996",
"1207931717530335",
"1207816263671761",
"1206082775373071",
"1208183190857136",
"1201955186274436",
"1206393501402418",
"1202103809714710",
"1204250043888413",
"836807829489875",
"1202103717323633",
"1202008494907041",
"1201994653016894",
"1203644940821003",
"1202664499015949",
"1209205137475783",
"1202067262153755",
"1201997724904303",
"1210835404446332",
"1210889535977773",
"1206394483540315",
"1206363754570915",
"1205353734392634",
"1202598063397774",
"1203185755588476",
"1210873210287559",
"1202971583662880",
"1208600372368707",
"1202473135917638",
"1211117741325774",
"1202067263383878",
"1211184926575840",
"1210124803938200",
"1201995259444316",
"1209391945032267",
"1211413968568193",
"1201994636901967",
"1206355619759195",
"1211002007747820",
"1204320149396735",
"1201976495070655",
"1201959561838083",
"1204909348975911",
"1210129565236122",
"1211028564983415",
"1208574178647908",
"1206396054073411",
"1202029877560391",
"1210478192678626",
"1209391947899381",
"1207129822443940",
"1209371228065321",
"1207285748194854",
"cait1.21164E+15",
"1202103810014649",
"1202067261353489",
"705893338237500",
"1209582867880756",
"1205797057778863",
"1210467184621570",
"1159410326686249",
"1207721928698549",
"1203894445821642",
"1211118383980197",
"1211801318555534",
"1209324707997813",
"1201997748599110",
"1211796317554229",
"1207371717043739",
"1206595171320647",
"1211792420870735",
"1208873745193724",
"715809873266920",
"1211495866167897",
"1210039749266336",
"1204154752021419",
"1211637268379824",
"1208236324570171",
"1211489330798377",
"1199187158790731",
"888334325526069",
"1209773444928037",
"1200858667852392",
"1202103718886449",
"1202029935776209",
"1180237628314967",
"1204427552401501",
"1201236676138365",
"1206707027635152",
"1209589888865220",
"1204356110351656",
"1210941400014664",
"1206838003174635",
"1209020347269547",
"1209373005483148",
"1201994699804530",
"1206594099564496",
"1201994599417224",
"1204189444291008",
"1206124874487664",
"1205326220124712",
"1206494161312836",
"1203848708520233",
"1203848537002834",
"1208771061627949",
"1200856739086838",
"1207931717530263",
"1207743544295787",
"1202598063397832",
"1203871858478068",
"1202067222508732",
"1203281061714632",
"1202017683965876",
"1201994574141537",
"1202103765718385",
"1153054154859564",
"1206396054073415"
]

# Get access token
access_token = os.getenv("ASANA_ACCESS_TOKEN")
if not access_token:
    raise ValueError("ASANA_ACCESS_TOKEN not found in environment variables")

# Fetch task counts for all projects
results = []
for project_GID in project_GID_list:
    task_count = get_task_count_from_project_GID(project_GID, access_token)
    results.append({
        "project_gid": project_GID,
        "task_count": task_count
    })
    print(f"Project {project_GID} has {task_count} tasks")

# Sort results by task count (descending order)
results_sorted = sorted(results, key=lambda x: x['task_count'], reverse=True)

# Save to JSON file
output_file = 'project_task_counts.json'
with open(output_file, 'w') as f:
    json.dump(results_sorted, f, indent=2)

print(f"\nResults saved to {output_file} (sorted by task count)")
